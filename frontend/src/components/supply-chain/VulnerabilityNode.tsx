import { memo } from 'react';
import { Handle, Position, type NodeProps } from '@xyflow/react';
import { ShieldAlert, ExternalLink } from 'lucide-react';
import type { VulnerabilityNodeData } from './useGraphLayout';

const getSeverityColor = (severity: string) => {
  switch (severity) {
    case 'critical':
      return {
        badge: 'bg-destructive/10 text-destructive border-destructive/20',
        icon: 'text-destructive',
      };
    case 'high':
      return {
        badge: 'bg-orange-500/10 text-orange-500 border-orange-500/20',
        icon: 'text-orange-500',
      };
    case 'medium':
      return {
        badge: 'bg-warning/10 text-warning border-warning/20',
        icon: 'text-warning',
      };
    case 'low':
      return {
        badge: 'bg-foreground-secondary/10 text-foreground-secondary border-foreground-secondary/20',
        icon: 'text-foreground-secondary',
      };
    default:
      return {
        badge: 'bg-foreground-secondary/10 text-foreground-secondary border-foreground-secondary/20',
        icon: 'text-foreground-secondary',
      };
  }
};

function getDepscoreBadgeClass(score: number): string {
  if (score >= 75) return 'bg-destructive/10 text-destructive border-destructive/20';
  if (score >= 40) return 'bg-warning/10 text-warning border-warning/20';
  return 'bg-foreground-secondary/10 text-foreground-secondary border-foreground-secondary/20';
}

function VulnerabilityNodeComponent({ data }: NodeProps) {
  const nodeData = data as unknown as VulnerabilityNodeData;
  const colors = getSeverityColor(nodeData.severity);

  const link = nodeData.osvId.startsWith('GHSA-')
    ? `https://github.com/advisories/${nodeData.osvId}`
    : `https://osv.dev/vulnerability/${nodeData.osvId}`;

  const cveAliases = (nodeData.aliases ?? [])
    .filter((a) => a.startsWith('CVE-'))
    .slice(0, 2);

  return (
    <div className="relative group">
      {/* Handles on all four sides */}
      <Handle id="top" type="target" position={Position.Top} className="!opacity-0 !w-0 !h-0 !min-w-0 !min-h-0 !border-0 !p-0" />
      <Handle id="right" type="target" position={Position.Right} className="!opacity-0 !w-0 !h-0 !min-w-0 !min-h-0 !border-0 !p-0" />
      <Handle id="bottom" type="target" position={Position.Bottom} className="!opacity-0 !w-0 !h-0 !min-w-0 !min-h-0 !border-0 !p-0" />
      <Handle id="left" type="target" position={Position.Left} className="!opacity-0 !w-0 !h-0 !min-w-0 !min-h-0 !border-0 !p-0" />

      <div
        className="rounded-lg border border-border bg-background-card shadow-md transition-all hover:shadow-lg"
        style={{ minWidth: 190, maxWidth: 230 }}
      >
        {/* Header: severity badge + icon */}
        <div className="px-3 py-2.5 flex items-start gap-2">
          <ShieldAlert className={`h-3.5 w-3.5 mt-0.5 flex-shrink-0 ${colors.icon}`} />
          <div className="min-w-0 flex-1">
            <div className="flex items-center gap-1.5 mb-1 flex-wrap">
              <span
                className={`inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold border capitalize ${colors.badge}`}
              >
                {nodeData.severity}
              </span>
              {nodeData.depscore != null && (
                <span
                  className={`inline-flex items-center justify-center min-w-[1.75rem] px-1.5 py-0.5 rounded-full text-[10px] font-medium border ${getDepscoreBadgeClass(nodeData.depscore)}`}
                  title="Depscore"
                >
                  {nodeData.depscore}
                </span>
              )}
            </div>
            {/* OSV ID link */}
            <a
              href={link}
              target="_blank"
              rel="noopener noreferrer"
              className="text-[11px] font-mono font-medium text-foreground hover:text-foreground-secondary flex items-center gap-0.5 transition-colors"
              onClick={(e) => e.stopPropagation()}
            >
              {nodeData.osvId}
              <ExternalLink className="h-2.5 w-2.5 flex-shrink-0" />
            </a>
            {/* CVE aliases */}
            {cveAliases.length > 0 && (
              <p className="text-[10px] text-foreground-muted mt-0.5">
                {cveAliases.join(', ')}
              </p>
            )}
          </div>
        </div>

        {/* Summary */}
        {nodeData.summary && (
          <div className="px-3 pb-2.5 pt-0">
            <p className="text-[10px] text-foreground-secondary line-clamp-2 leading-relaxed">
              {nodeData.summary}
            </p>
          </div>
        )}
      </div>
    </div>
  );
}

export const VulnerabilityNode = memo(VulnerabilityNodeComponent);
