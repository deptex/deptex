import { memo, useState, useEffect, useCallback } from 'react';
import {
  Shield, ShieldAlert, ShieldCheck, Flame, ExternalLink, ChevronDown, ChevronRight,
  AlertTriangle, CheckCircle, Clock, FileCode, Eye, EyeOff, Ban, Sparkles
} from 'lucide-react';
import { cn } from '../../lib/utils';
import { api, VulnerabilityDetail, VersionCandidate } from '../../lib/api';

interface VulnerabilityDetailContentProps {
  organizationId: string;
  projectId: string;
  osvId: string;
  canManage: boolean;
  onNavigateToDep?: (depId: string) => void;
}

function getDepscoreBadgeClass(score: number | null | undefined): string {
  if (score == null) return 'bg-zinc-800 text-zinc-400';
  if (score >= 75) return 'bg-red-500/15 text-red-400 border border-red-500/30';
  if (score >= 40) return 'bg-amber-500/15 text-amber-400 border border-amber-500/30';
  return 'bg-zinc-700/50 text-zinc-400 border border-zinc-600/30';
}

function getSeverityBadgeClass(severity: string): string {
  switch (severity) {
    case 'critical': return 'bg-red-500/15 text-red-400';
    case 'high': return 'bg-orange-500/15 text-orange-400';
    case 'medium': return 'bg-yellow-500/15 text-yellow-400';
    case 'low': return 'bg-zinc-700/50 text-zinc-400';
    default: return 'bg-zinc-700/50 text-zinc-400';
  }
}

function formatTimeAgo(date: string): string {
  const diff = Date.now() - new Date(date).getTime();
  const hours = Math.floor(diff / 3600000);
  if (hours < 1) return 'just now';
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 30) return `${days}d ago`;
  const months = Math.floor(days / 30);
  return `${months}mo ago`;
}

function CollapsibleSection({ title, icon: Icon, defaultOpen = false, badge, children }: {
  title: string;
  icon?: any;
  defaultOpen?: boolean;
  badge?: React.ReactNode;
  children: React.ReactNode;
}) {
  const [isOpen, setIsOpen] = useState(defaultOpen);
  return (
    <div className="border border-border rounded-lg overflow-hidden">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="w-full flex items-center justify-between px-4 py-3 hover:bg-zinc-800/50 transition-colors"
      >
        <div className="flex items-center gap-2">
          {Icon && <Icon className="h-4 w-4 text-zinc-400" />}
          <span className="text-sm font-medium text-foreground">{title}</span>
          {badge}
        </div>
        {isOpen ? <ChevronDown className="h-4 w-4 text-zinc-500" /> : <ChevronRight className="h-4 w-4 text-zinc-500" />}
      </button>
      {isOpen && <div className="px-4 pb-4 border-t border-border">{children}</div>}
    </div>
  );
}

function VulnerabilityDetailContent({ organizationId, projectId, osvId, canManage, onNavigateToDep }: VulnerabilityDetailContentProps) {
  const [detail, setDetail] = useState<VulnerabilityDetail | null>(null);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState(false);

  const loadDetail = useCallback(async () => {
    setLoading(true);
    try {
      const data = await api.getVulnerabilityDetail(organizationId, projectId, osvId);
      setDetail(data);
    } catch (e) {
      console.error('Failed to load vulnerability detail:', e);
    } finally {
      setLoading(false);
    }
  }, [organizationId, projectId, osvId]);

  useEffect(() => { loadDetail(); }, [loadDetail]);

  const handleSuppress = useCallback(async () => {
    setActionLoading(true);
    try {
      if (detail?.vulnerability.suppressed) {
        await api.unsuppressVulnerability(organizationId, projectId, osvId);
      } else {
        await api.suppressVulnerability(organizationId, projectId, osvId);
      }
      await loadDetail();
    } finally {
      setActionLoading(false);
    }
  }, [organizationId, projectId, osvId, detail, loadDetail]);

  const handleAcceptRisk = useCallback(async () => {
    setActionLoading(true);
    try {
      if (detail?.vulnerability.risk_accepted) {
        await api.unacceptVulnerabilityRisk(organizationId, projectId, osvId);
      } else {
        await api.acceptVulnerabilityRisk(organizationId, projectId, osvId);
      }
      await loadDetail();
    } finally {
      setActionLoading(false);
    }
  }, [organizationId, projectId, osvId, detail, loadDetail]);

  if (loading) {
    return (
      <div className="space-y-4">
        {[1, 2, 3].map(i => (
          <div key={i} className="h-20 bg-zinc-800/50 rounded-lg animate-pulse" />
        ))}
      </div>
    );
  }

  if (!detail) {
    return <div className="text-sm text-zinc-400">Vulnerability not found.</div>;
  }

  const { vulnerability: vuln, affected_dependencies: affectedDeps, version_candidates: candidates, timeline_events: events } = detail;
  const isSuppressed = vuln.suppressed === true;
  const isAccepted = vuln.risk_accepted === true;

  const osvLink = osvId.startsWith('GHSA-')
    ? `https://github.com/advisories/${osvId}`
    : `https://osv.dev/vulnerability/${osvId}`;

  const cveAlias = vuln.aliases?.find((a: string) => a.startsWith('CVE-'));
  const ghsaAlias = vuln.aliases?.find((a: string) => a.startsWith('GHSA-'));

  const sameMajorCandidate = candidates.find((c: VersionCandidate) => c.candidate_type === 'same_major_safe');
  const fixAvailable = !!sameMajorCandidate || candidates.some((c: VersionCandidate) => c.candidate_type === 'fully_safe');

  return (
    <div className="space-y-4">
      {/* Risk Badges Row */}
      <div className="flex items-center gap-2 flex-wrap">
        <span className={cn('px-2 py-0.5 rounded text-xs font-mono font-medium', getSeverityBadgeClass(vuln.severity))}>
          {vuln.severity?.toUpperCase()}
        </span>
        {vuln.depscore != null && (
          <span className={cn('px-2 py-0.5 rounded text-xs font-mono font-medium', getDepscoreBadgeClass(vuln.depscore))}>
            DS {vuln.depscore}
          </span>
        )}
        {vuln.epss_score != null && (
          <span className="px-2 py-0.5 rounded text-xs font-mono bg-zinc-800 text-zinc-400">
            EPSS {(vuln.epss_score * 100).toFixed(1)}%
          </span>
        )}
        {vuln.cisa_kev && (
          <span className="px-2 py-0.5 rounded text-xs font-mono bg-red-500/15 text-red-400 flex items-center gap-1">
            <Flame className="h-3 w-3" /> KEV
          </span>
        )}
        {vuln.is_reachable && (
          <span className="px-2 py-0.5 rounded text-xs font-mono bg-red-500/15 text-red-400 flex items-center gap-1">
            <Shield className="h-3 w-3" /> Reachable
          </span>
        )}
        {fixAvailable && (
          <span className="px-2 py-0.5 rounded text-xs font-mono bg-green-500/15 text-green-400 flex items-center gap-1">
            <CheckCircle className="h-3 w-3" /> Fix available
          </span>
        )}
        {isSuppressed && (
          <span className="px-2 py-0.5 rounded text-xs font-mono bg-zinc-700 text-zinc-400 flex items-center gap-1">
            <EyeOff className="h-3 w-3" /> Suppressed
          </span>
        )}
        {isAccepted && (
          <span className="px-2 py-0.5 rounded text-xs font-mono bg-amber-500/15 text-amber-400 flex items-center gap-1">
            <CheckCircle className="h-3 w-3" /> Risk accepted
          </span>
        )}
      </div>

      {/* CISA KEV Warning Banner */}
      {vuln.cisa_kev && (
        <div className="flex items-center gap-2 px-3 py-2 rounded-lg bg-red-500/10 border border-red-500/20">
          <Flame className="h-4 w-4 text-red-400 flex-shrink-0" />
          <span className="text-xs text-red-300">Listed in CISA Known Exploited Vulnerabilities catalog — active exploitation observed.</span>
        </div>
      )}

      {/* Description */}
      <CollapsibleSection title="Description" icon={FileCode} defaultOpen>
        <div className="pt-3 space-y-3">
          <p className="text-sm text-zinc-300 leading-relaxed">{vuln.summary || 'No description available.'}</p>
          <button
            disabled
            className="text-xs text-zinc-500 flex items-center gap-1 cursor-not-allowed"
            title="Configure AI in Organization Settings"
          >
            <Sparkles className="h-3 w-3" /> Explain with Aegis
          </button>
        </div>
      </CollapsibleSection>

      {/* Affected Code */}
      <CollapsibleSection
        title="Affected Code"
        icon={FileCode}
        badge={
          <span className="text-xs text-zinc-500">{affectedDeps.length} dep{affectedDeps.length !== 1 ? 's' : ''}</span>
        }
      >
        <div className="pt-3 space-y-3">
          {affectedDeps.map((dep) => (
            <div key={dep.id} className="border border-border rounded-lg p-3">
              <div className="flex items-center justify-between">
                <button
                  className="text-sm font-medium text-foreground hover:text-primary transition-colors"
                  onClick={() => onNavigateToDep?.(dep.id)}
                >
                  {dep.name}
                </button>
                <div className="flex items-center gap-2">
                  <span className="text-xs font-mono text-zinc-400">{dep.version}</span>
                  <span className={cn('px-1.5 py-0.5 rounded text-[10px]', dep.is_direct ? 'bg-blue-500/15 text-blue-400' : 'bg-zinc-700 text-zinc-400')}>
                    {dep.is_direct ? 'direct' : 'transitive'}
                  </span>
                </div>
              </div>
              {dep.files.length > 0 && (
                <div className="mt-2 space-y-1">
                  {dep.files.slice(0, 5).map((f, i) => (
                    <div key={i} className="text-xs text-zinc-500 font-mono truncate">{f}</div>
                  ))}
                  {dep.files.length > 5 && (
                    <div className="text-xs text-zinc-500">+{dep.files.length - 5} more files</div>
                  )}
                </div>
              )}
              {dep.files.length === 0 && (
                <div className="mt-1 text-xs text-amber-500/80">Not directly imported in your code</div>
              )}
            </div>
          ))}
        </div>
      </CollapsibleSection>

      {/* Fix Options */}
      <CollapsibleSection title="Fix Options" icon={ShieldCheck} defaultOpen>
        <div className="pt-3 space-y-3">
          {sameMajorCandidate && (
            <div className="border border-border rounded-lg p-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="px-1.5 py-0.5 rounded text-[10px] bg-green-500/15 text-green-400">same-major fix</span>
                  <span className="text-sm font-mono text-foreground">{sameMajorCandidate.candidate_version}</span>
                </div>
                {sameMajorCandidate.is_org_banned && (
                  <span className="px-1.5 py-0.5 rounded text-[10px] bg-red-500/15 text-red-400">Banned</span>
                )}
              </div>
              <div className="mt-1 text-xs text-zinc-400">
                Fixes {sameMajorCandidate.fixes_cve_count}/{sameMajorCandidate.total_current_cves} CVEs
                {sameMajorCandidate.known_new_cves > 0
                  ? ` · ${sameMajorCandidate.known_new_cves} known new CVEs`
                  : ' · 0 known new CVEs'}
              </div>
              {sameMajorCandidate.verified_at && (
                <VerifiedAtLabel verifiedAt={sameMajorCandidate.verified_at} />
              )}
            </div>
          )}

          {candidates.filter(c => c.candidate_type === 'fully_safe').map(c => (
            <div key={c.id} className="border border-border rounded-lg p-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  {c.is_major_bump && (
                    <span className="px-1.5 py-0.5 rounded text-[10px] bg-amber-500/15 text-amber-400 flex items-center gap-0.5">
                      <AlertTriangle className="h-2.5 w-2.5" /> major bump
                    </span>
                  )}
                  <span className="text-sm font-mono text-foreground">{c.candidate_version}</span>
                </div>
                {c.is_org_banned && (
                  <span className="px-1.5 py-0.5 rounded text-[10px] bg-red-500/15 text-red-400">Banned</span>
                )}
              </div>
              <div className="mt-1 text-xs text-zinc-400">
                Fixes all {c.total_current_cves} CVEs
                {c.known_new_cves > 0 ? ` · ${c.known_new_cves} known new CVEs` : ''}
              </div>
              {c.verified_at && <VerifiedAtLabel verifiedAt={c.verified_at} />}
            </div>
          ))}

          {candidates.length === 0 && (
            <div className="text-sm text-zinc-500 flex items-center gap-2">
              <Ban className="h-4 w-4" /> No fix version available yet
            </div>
          )}

          <button
            disabled
            className="w-full py-2 rounded-lg text-sm font-medium bg-zinc-800 text-zinc-500 cursor-not-allowed flex items-center justify-center gap-2"
            title="Configure AI in Organization Settings"
          >
            <Sparkles className="h-4 w-4" /> Fix with AI
          </button>
        </div>
      </CollapsibleSection>

      {/* Timeline */}
      {events.length > 0 && (
        <CollapsibleSection title="Timeline" icon={Clock}>
          <div className="pt-3 space-y-2">
            {events.slice(0, 10).map((event) => (
              <div key={event.id} className="flex items-start gap-2">
                <div className="mt-1 h-1.5 w-1.5 rounded-full bg-zinc-500 flex-shrink-0" />
                <div>
                  <span className="text-xs text-zinc-300 capitalize">{event.event_type.replace(/_/g, ' ')}</span>
                  <span className="text-xs text-zinc-500 ml-2">{formatTimeAgo(event.created_at)}</span>
                </div>
              </div>
            ))}
          </div>
        </CollapsibleSection>
      )}

      {/* References */}
      <CollapsibleSection title="References" icon={ExternalLink}>
        <div className="pt-3 space-y-2">
          <a href={osvLink} target="_blank" rel="noopener noreferrer" className="text-xs text-primary hover:underline flex items-center gap-1">
            <ExternalLink className="h-3 w-3" /> {osvId.startsWith('GHSA-') ? 'GitHub Advisory' : 'OSV Database'}
          </a>
          {cveAlias && (
            <a href={`https://nvd.nist.gov/vuln/detail/${cveAlias}`} target="_blank" rel="noopener noreferrer" className="text-xs text-primary hover:underline flex items-center gap-1">
              <ExternalLink className="h-3 w-3" /> NVD ({cveAlias})
            </a>
          )}
          {ghsaAlias && ghsaAlias !== osvId && (
            <a href={`https://github.com/advisories/${ghsaAlias}`} target="_blank" rel="noopener noreferrer" className="text-xs text-primary hover:underline flex items-center gap-1">
              <ExternalLink className="h-3 w-3" /> GHSA ({ghsaAlias})
            </a>
          )}
        </div>
      </CollapsibleSection>

      {/* Action Buttons */}
      {canManage && (
        <div className="flex items-center gap-2 pt-2">
          <button
            onClick={handleSuppress}
            disabled={actionLoading}
            className={cn(
              'flex-1 py-2 rounded-lg text-xs font-medium transition-colors',
              isSuppressed
                ? 'bg-zinc-800 text-zinc-300 hover:bg-zinc-700'
                : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'
            )}
          >
            {isSuppressed ? (
              <span className="flex items-center justify-center gap-1"><Eye className="h-3 w-3" /> Unsuppress</span>
            ) : (
              <span className="flex items-center justify-center gap-1"><EyeOff className="h-3 w-3" /> Suppress</span>
            )}
          </button>
          <button
            onClick={handleAcceptRisk}
            disabled={actionLoading}
            className={cn(
              'flex-1 py-2 rounded-lg text-xs font-medium transition-colors',
              isAccepted
                ? 'bg-amber-500/15 text-amber-400 hover:bg-amber-500/25'
                : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'
            )}
          >
            {isAccepted ? 'Revoke Acceptance' : 'Accept Risk'}
          </button>
        </div>
      )}
    </div>
  );
}

function VerifiedAtLabel({ verifiedAt }: { verifiedAt: string }) {
  const hoursAgo = (Date.now() - new Date(verifiedAt).getTime()) / 3600000;
  if (hoursAgo < 48) return null;
  if (hoursAgo > 168) {
    return <div className="mt-1 text-[10px] text-amber-400">May be outdated — verified {Math.floor(hoursAgo / 24)}d ago</div>;
  }
  return <div className="mt-1 text-[10px] text-zinc-500">Last verified {Math.floor(hoursAgo)}h ago</div>;
}

export default memo(VulnerabilityDetailContent);
